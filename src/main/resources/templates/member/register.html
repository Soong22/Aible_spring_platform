<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>회원 가입</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<!-- Header -->
<div th:replace="~{layouts/header :: header}"></div>

<!-- Main Content -->
<h1>회원 가입</h1>

<form action="/member/register" method="post" id="registrationForm">

    <label for="email">이메일:</label>
    <input type="email" id="email" name="email" required>
    <button type="button" id="checkEmailBtn">이메일 중복 확인</button>
    <br>

    <label for="password">비밀번호:</label>
    <input type="password" id="password" name="password" required minlength="8" maxlength="20">
    <br>

    <label for="memberName">사용자 이름:</label>
    <input type="text" id="memberName" name="memberName" required minlength="2" maxlength="50">
    <br>

    <label for="personPhone">개인전화번호:</label>
    <input type="tel" id="personPhone" name="personPhone" required>
    <br>

    <label for="officePhone">사무실전화번호:</label>
    <input type="tel" id="officePhone" name="officePhone">
    <br>

    <label for="districtName">관활부서:</label>
    <input type="text" id="districtName" name="districtName" required maxlength="50">
    <br>

    <!-- 숨겨진 필드에 이메일 값을 저장 -->
    <input type="hidden" id="hiddenEmail" name="email">

    <button type="submit" id="submitBtn" disabled>회원 가입</button>

</form>

<!-- Footer -->
<div th:replace="~{layouts/footer :: footer}"></div>


<script>
    const checkEmailBtn = document.getElementById('checkEmailBtn');
    const submitBtn = document.getElementById('submitBtn');
    const emailInput = document.getElementById('email');
    const hiddenEmailInput = document.getElementById('hiddenEmail');
    const personPhoneInput = document.getElementById('personPhone');
    const officePhoneInput = document.getElementById('officePhone');
    const memberNameInput = document.getElementById('memberName');
    const passwordInput = document.getElementById('password');

    // 이메일 중복 확인 후 임시 변수에 저장
    let emailValue = '';

    // 이메일 중복 확인 버튼 클릭 시 처리
    checkEmailBtn.addEventListener('click', function () {
        const email = emailInput.value;

        if (!email) {
            alert('이메일을 입력해주세요.');
            return;
        }

        fetch(`/check-email/${encodeURIComponent(email)}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    alert('이미 사용 중인 이메일입니다. 다른 이메일을 사용해주세요.');
                    submitBtn.disabled = true; // 이메일 중복일 경우 회원가입 버튼 비활성화
                } else {
                    alert('사용 가능한 이메일입니다.');
                    submitBtn.disabled = false; // 이메일 사용 가능 시 회원가입 버튼 활성화

                    // 이메일을 임시 변수에 저장
                    emailValue = email;
                    emailInput.disabled = true; // 이메일 필드 비활성화 (수정 불가)
                    checkEmailBtn.disabled = true; // 중복 확인 버튼 비활성화 (다시 클릭 불가)

                    // hidden 필드에 이메일 값 저장
                    hiddenEmailInput.value = emailValue;
                }
            })
            .catch(error => {
                console.error('에러 발생:', error);
                alert('이메일 중복 확인에 실패했습니다. 다시 시도해주세요.');
            });
    });

    // 폼 제출 시 이메일, 사용자 이름, 전화번호, 비밀번호 검증
    document.getElementById('registrationForm').addEventListener('submit', function (event) {
        if (!emailValue) {
            alert('이메일 중복 확인을 먼저 해주세요.');
            event.preventDefault(); // 이메일 중복 확인을 하지 않으면 제출을 막습니다.
            return;
        }

        // 비밀번호 검증 (8자 이상 20자 이하)
        const password = passwordInput.value;
        if (password.length < 8 || password.length > 20) {
            alert('비밀번호는 8자 이상 20자 이하로 입력해주세요.');
            event.preventDefault();
        }

        // 사용자 이름 검증 (2자 이상 50자 이하)
        const memberName = memberNameInput.value;
        if (memberName.length < 2 || memberName.length > 50) {
            alert('사용자 이름은 2자 이상 50자 이하로 입력해주세요.');
            event.preventDefault();
            return;
        }

        // 개인 전화번호 검증 (010-123-4567, 011-1234-5678 형식)
        const personPhone = personPhoneInput.value;
        const phoneRegex = /^01[0-9]-\d{3,4}-\d{4}$/;
        if (!phoneRegex.test(personPhone)) {
            alert('개인전화번호는 010-1234-5678형식이어야 합니다.');
            event.preventDefault();
            return;
        }

        // 사무실 전화번호 검증 (062-123-4567, 02-124-5678 형식, 선택사항이므로 빈 값 허용)
        const officePhone = officePhoneInput.value;
        const officePhoneRegex = /^(02|0[3-9]{1}[0-9]{1})-\d{3,4}-\d{4}$/;
        if (officePhone && !officePhoneRegex.test(officePhone)) {
            alert('사무실전화번호는 02-123-4567 또는 062-123-4567 형식이어야 합니다.');
            event.preventDefault();
        }
    });
</script>
</body>
</html>

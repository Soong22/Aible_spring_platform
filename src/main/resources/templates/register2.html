<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 가입</title>
</head>
<body>

<h1>회원 가입</h1>

<form action="/register" method="post" id="registrationForm">

    <label for="memberName">사용자 이름:</label>
    <input type="text" id="memberName" name="memberName" required minlength="2" maxlength="50">
    <br>

    <label for="phoneNumber">전화번호:</label>
    <input type="tel" id="phoneNumber" name="phoneNumber" required>
    <br>

    <label for="email">이메일:</label>
    <input type="email" id="email" name="email" required>
    <button type="button" id="checkEmailBtn">이메일 중복 확인</button>
    <br>

    <label for="password">비밀번호:</label>
    <input type="password" id="password" name="password" required minlength="8" maxlength="20">
    <br>

    <!-- 새로운 항목 추가 -->
    <label for="sido">시도청:</label>
    <select id="sido" name="sido" required>
        <option value="">선택</option>
        <option value="광주청">광주청</option>
    </select>
    <br>

    <label for="policeStation">경찰서:</label>
    <select id="policeStation" name="policeStation" required>
        <option value="">시도청을 먼저 선택해주세요</option>
    </select>
    <br>

    <label for="subStation">관서명:</label>
    <select id="subStation" name="subStation" required>
        <option value="">경찰서를 먼저 선택해주세요</option>
    </select>
    <br>

    <label for="category">구분:</label>
    <select id="category" name="category" required>
        <option value="">관서명을 먼저 선택해주세요</option>
    </select>
    <br>

    <!-- 숨겨진 필드에 이메일 값을 저장 -->
    <input type="hidden" id="hiddenEmail" name="email">

    <button type="submit" id="submitBtn" disabled>회원 가입</button>

</form>

<script>
    const checkEmailBtn = document.getElementById('checkEmailBtn');
    const submitBtn = document.getElementById('submitBtn');
    const emailInput = document.getElementById('email');
    const hiddenEmailInput = document.getElementById('hiddenEmail');
    const phoneInput = document.getElementById('phoneNumber');
    const memberNameInput = document.getElementById('memberName');
    const passwordInput = document.getElementById('password');
    const sidoSelect = document.getElementById('sido');
    const policeStationSelect = document.getElementById('policeStation');
    const subStationSelect = document.getElementById('subStation');
    const categorySelect = document.getElementById('category');

    // 이메일 중복 확인 후 임시 변수에 저장
    let emailValue = '';

    // 경찰서와 관서명, 구분 데이터
    const stationsData = {
        '광주청': {
            '광주광산': {
                '관서': ['수완', '첨단', '우산', '월곡', '도산', '송정', '하남', '비아', '평동', '동곡', '삼도', '본량', '임곡'],
                '구분': {
                    '수완': '지구대', '첨단': '지구대', '우산': '지구대', '월곡': '지구대', '도산': '파출소', '송정': '파출소',
                    '하남': '파출소', '비아': '파출소', '평동': '파출소', '동곡': '파출소', '삼도': '파출소', '본량': '파출소',
                    '임곡': '파출소'
                }
            },
            '광주동부': {
                '관서': ['금남', '학서', '산수', '지원', '지산'],
                '구분': { '금남': '지구대', '학서': '파출소', '산수': '파출소', '지원': '파출소', '지산': '파출소' }
            },
            '광주서부': {
                '관서': ['금호', '상무', '화정', '농성', '동천', '염주', '풍암'],
                '구분': { '금호': '지구대', '상무': '지구대', '화정': '지구대', '농성': '파출소', '동천': '파출소', '염주': '파출소', '풍암': '파출소' }
            },
            '광주남부': {
                '관서': ['백운', '방림', '효덕', '양림', '주월', '대촌'],
                '구분': { '백운': '지구대', '방림': '지구대', '효덕': '지구대', '양림': '파출소', '주월': '파출소', '대촌': '파출소' }
            },
            '광주북부': {
                '관서': ['우산', '동운', '두암', '용봉', '일곡', '문흥', '역전', '건국', '석곡'],
                '구분': { '우산': '지구대', '동운': '지구대', '두암': '지구대', '용봉': '지구대', '일곡': '지구대', '문흥': '지구대', '역전': '지구대', '건국': '지구대', '석곡': '파출소' }
            }
        }
    };

    // 이메일 중복 확인 버튼 클릭 시 처리
    checkEmailBtn.addEventListener('click', function() {
        const email = emailInput.value;

        if (!email) {
            alert('이메일을 입력해주세요.');
            return;
        }

        fetch(`/check-email/${encodeURIComponent(email)}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    alert('이미 사용 중인 이메일입니다. 다른 이메일을 사용해주세요.');
                    submitBtn.disabled = true; // 이메일 중복일 경우 회원가입 버튼 비활성화
                } else {
                    alert('사용 가능한 이메일입니다.');
                    submitBtn.disabled = false; // 이메일 사용 가능 시 회원가입 버튼 활성화

                    // 이메일을 임시 변수에 저장
                    emailValue = email;
                    emailInput.disabled = true; // 이메일 필드 비활성화 (수정 불가)
                    checkEmailBtn.disabled = true; // 중복 확인 버튼 비활성화 (다시 클릭 불가)

                    // hidden 필드에 이메일 값 저장
                    hiddenEmailInput.value = emailValue;
                }
            })
            .catch(error => {
                console.error('에러 발생:', error);
                alert('이메일 중복 확인에 실패했습니다. 다시 시도해주세요.');
            });
    });

    // 시도청 선택 변경 시 경찰서 업데이트
    sidoSelect.addEventListener('change', function() {
        const sido = sidoSelect.value;
        const policeStations = stationsData[sido] || {};

        // 경찰서 셀렉트 초기화
        policeStationSelect.innerHTML = '<option value="">경찰서를 선택하세요</option>';

        // 경찰서 옵션 추가
        for (const policeStation in policeStations) {
            const option = document.createElement('option');
            option.value = policeStation;
            option.textContent = policeStation;
            policeStationSelect.appendChild(option);
        }

        // 관서명과 구분 초기화
        subStationSelect.innerHTML = '<option value="">경찰서를 선택하세요</option>';
        categorySelect.innerHTML = '<option value="">관서명을 먼저 선택해주세요</option>';
    });

    // 경찰서 선택 변경 시 관서명 및 구분 업데이트
    policeStationSelect.addEventListener('change', function() {
        const policeStation = policeStationSelect.value;
        const stationData = stationsData['광주청'][policeStation] || {};

        // 관서명 셀렉트 초기화
        subStationSelect.innerHTML = '<option value="">관서명을 선택하세요</option>';

        // 구분 셀렉트 초기화
        categorySelect.innerHTML = '<option value="">관서명을 먼저 선택해주세요</option>';

        // 관서명 옵션 추가
        stationData['관서']?.forEach(subStation => {
            const option = document.createElement('option');
            option.value = subStation;
            option.textContent = subStation;
            subStationSelect.appendChild(option);
        });

        // 관서명이 선택될 때마다 구분을 자동으로 추가
        subStationSelect.addEventListener('change', function() {
            const selectedSubStation = subStationSelect.value;
            if (selectedSubStation) {
                const category = stationData['구분'][selectedSubStation];
                categorySelect.innerHTML = '<option value="">구분</option>'; // 구분 초기화
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
        });
    });

    // 폼 제출 시 이메일, 사용자 이름, 전화번호, 비밀번호 검증
    document.getElementById('registrationForm').addEventListener('submit', function(event) {
        if (!emailValue) {
            alert('이메일 중복 확인을 먼저 해주세요.');
            event.preventDefault(); // 이메일 중복 확인을 하지 않으면 제출을 막습니다.
            return;
        }

        // 사용자 이름 검증 (2자 이상 50자 이하)
        const memberName = memberNameInput.value;
        if (memberName.length < 2 || memberName.length > 50) {
            alert('사용자 이름은 2자 이상 50자 이하로 입력해주세요.');
            event.preventDefault();
            return;
        }

        // 전화번호 검증 (010-123-4567, 011-1234-5678 형식)
        const phoneNumber = phoneInput.value;
        const phoneRegex = /^01[0-9]-\d{3,4}-\d{4}$/;
        if (!phoneRegex.test(phoneNumber)) {
            alert('전화번호 형식이 올바르지 않습니다.');
            event.preventDefault();
            return;
        }

        // 비밀번호 검증 (8자 이상 20자 이하)
        const password = passwordInput.value;
        if (password.length < 8 || password.length > 20) {
            alert('비밀번호는 8자 이상 20자 이하로 입력해주세요.');
            event.preventDefault();
            return;
        }

    });

</script>
</body>
</html>
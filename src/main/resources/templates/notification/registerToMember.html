<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0,
    maximum-scale=2.0, minimum-scale=1.0, user-scalable=yes"/>
  <title>알림 작성</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- css -->
  <!--[if lt IE 9]>
  <link rel="stylesheet" type="text/css" href="/css/font_ie8.css"/><![endif]-->
  <link rel="stylesheet" type="text/css" href="/css/font.css"/>
  <link rel="stylesheet" type="text/css" href="/css/cctv/main.css"/>
  <link rel="stylesheet" type="text/css" href="/css/top_button.css"/>

  <!-- js -->
  <!--[if lt IE 9]>
  <script src="/js/html5.js"></script><![endif]-->
  <script src="/js/jquery-1.12.4.min.js"></script>
  <script src="/js/jquery.screen.min.js"></script>
  <script src="/js/jquery.menu.min.js"></script>
  <script src="/js/jquery.customForm.min.js"></script>
  <script src="/js/slick.min.js"></script>
  <script src="/js/slick.extensions.min.js"></script>
  <script src="/js/layout.js"></script>
  <script src="/js/program.min.js"></script>
  <script src="/js/cctv/common.js"></script>
  <script src="/js/cctv/main.js"></script>
  <script src="/js/loading.js"></script>
  <script src="/js/top_button.js"></script>

  <style>
    .form-container {
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background-color: white;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .form-container h1 {
      text-align: center;
      color: #000820;
      margin-bottom: 20px;
      font-size: 30pt;
    }

    #previewList {
      margin-top: 40px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .preview-item {
      position: relative;
      width: 100px;
      height: 100px;
    }

    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .preview-item button {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 12px;
      color: white;
      background-color: #dc3545;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-item button:hover {
      background-color: #c82333;
    }

    .file-input-wrapper {
      position: relative;
      width: 100%;
      height: 50px;
      margin-bottom: 20px;
    }

    .file-input-wrapper label {
      display: block;
      width: 100%;
      height: 100%;
      background-color: #000820;
      color: white;
      text-align: center;
      line-height: 50px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }

    .file-input-wrapper label:hover {
      background-color: #444f6e;
    }

    .file-input-wrapper input[type="file"] {
      display: none;
    }

    .button-container {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    /* 작성하기 버튼 색상 변경 */
    .btn-primary {
      background-color: #000820 !important;
      border-color: #000820 !important;
      color: white !important;
    }

    .btn-primary:hover {
      background-color: #444f6e !important; /* 어두운 톤 */
      border-color: #444f6e !important;
    }

    .container {
      max-width: 800px;
      margin-top: 50px;
    }

    .error-message {
      color: red;
      margin-bottom: 15px;
    }

    .file-input-label {
      cursor: pointer;
    }

    .preview-image {
      max-width: 200px;
      margin: 10px;
    }
  </style>

  <script>
    // 뒤로가기 시 강제 새로고침
    if (performance.getEntriesByType("navigation")[0]?.type === "back_forward") {
      location.reload(true);
    }
  </script>

  <script th:inline="javascript" th:if="${errorMessage != null}">
    /*<![CDATA[*/
    var msg = /*[[${errorMessage}]]*/ "";
    alert(msg);
    /*]]>*/
  </script>

  <!--알림창 관련 (toastr, stomp 등)-->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <script>
    // WebSocket 연결 생성
    var socket = new SockJS('/ws');
    var stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
      console.log('WebSocket 연결됨: ' + frame);
      stompClient.subscribe('/user/queue/notifications', function(message) {
        var notification = JSON.parse(message.body);
        showNotificationPopup(notification);
      });
    });

    // 푸쉬 알림 팝업을 표시하는 함수
    function showNotificationPopup(notification) {
      toastr.options = {
        "closeButton": true,
        "debug": false,
        "newestOnTop": true,
        "progressBar": true,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": function() {
          window.location.href = "/notification/" + notification.notificationId;
        },
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": 0,
        "extendedTimeOut": 0,
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
      };
      toastr.info("관리자에게 지원요청이 들어왔습니다.");
    }
  </script>

  <style>
    /* 기본 토스트 스타일 오버라이드 */
    .toast {
      opacity: 1 !important;
      width: 300px !important;
      height: 70px !important;
      line-height: 1.2;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      z-index: 9999999999;
    }
    .toast-top-right {
      top: 60px !important;
    }
    .toast-info {
      background-color: #007bff !important;
      color: #ffffff !important;
      border: 1px solid #0056b3 !important;
    }
    .toast-close-button {
      color: #ffffff !important;
      font-size: 1.2rem;
    }
  </style>

</head>
<body>

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}" class="header"></div>

<!-- Main Content -->
<div id="wrapper">
  <div class="form-container">
    <h1>알림 작성</h1>

    <form id="notificationForm"
          th:action="@{/notification/register}"
          method="post"
          enctype="multipart/form-data">
      <!-- CSRF 토큰 (Hidden) -->
      <input type="hidden" id="_csrf" name="_csrf" th:value="${_csrf.token}">

      <!-- 수신자 정보: receiverId, 이름, 파출소 정보 등 -->
      <div class="mb-3">
        <label class="form-label">수신자</label>
        <p class="form-control-plaintext">
          <!-- ex) "파출소명 (파출소타입) - 홍길동" 등으로 표시 -->
          <span th:text="${policeUnitName} + ' (' + ${policeUnitType} + ')' + ' - ' + ${receiverName}"></span>
        </p>

        <!-- 실제로 서버에 제출될 receiverId (숨김 필드) -->
        <input type="hidden" id="receiverId" name="receiverId" th:value="${receiverId}" />
      </div>

      <!-- 내용 입력 -->
      <div class="mb-3">
        <label for="content" class="form-label">내용</label>
        <textarea id="content" name="content" rows="15" class="form-control"
                  required minlength="1" maxlength="10000"></textarea>
        <small class="form-text text-muted">1자 이상 10,000자 이내로 작성해주세요</small>
      </div>

      <!-- 이미지 파일 -->
      <div class="file-input-wrapper">
        <small class="text-muted">최대 5장까지 첨부 가능합니다.</small>
        <label for="photoFiles">사진/동영상 첨부하기</label>
        <input type="file" id="photoFiles" name="photoFiles" multiple>
      </div>

      <!-- 이미지 미리보기 -->
      <div id="previewList" class="mb-3"></div>

      <!-- 버튼 -->
      <div class="button-container">
        <button type="button" class="btn btn-secondary" onclick="cancelRegistration()">취소</button>
        <button type="submit" class="btn btn-primary">작성하기</button>
      </div>
    </form>
  </div>
</div>

<!--푸터-->
<div th:replace="~{fragments/footer :: footer}" id="footer"></div>

<script>
  // (1) 내용 유효성 검사
  function setupFormValidation(formId, contentId) {
    const form = document.getElementById(formId);
    const contentTextarea = document.getElementById(contentId);

    if (!form || !contentTextarea) {
      console.error('폼 요소를 찾을 수 없습니다. ID를 확인해주세요.');
      return;
    }

    form.addEventListener('submit', function (event) {
      const content = contentTextarea.value;
      const contentNonWhitespaceCount = content.replace(/\s/g, '').length;

      let isValid = true;
      let errorMessage = '';

      if (contentNonWhitespaceCount < 1) {
        isValid = false;
        errorMessage += '내용: 공백을 제외한 최소 1자 이상의 내용을 입력해주세요.\n';
      }

      if (!isValid) {
        alert(errorMessage);
        event.preventDefault();
      }
    });
  }

  // (2) 이미지 파일 추가/미리보기
  document.addEventListener("DOMContentLoaded", function () {
    setupFormValidation('notificationForm', 'content');

    const photoFilesInput = document.getElementById("photoFiles");
    const previewList = document.getElementById("previewList");

    let selectedFiles = [];

    photoFilesInput.addEventListener("change", async function () {
      let newFiles = Array.from(photoFilesInput.files);

      if (selectedFiles.length + newFiles.length > 5) {
        alert("이미지는 최대 5개까지만 첨부할 수 있습니다.");
        newFiles = newFiles.slice(0, 5 - selectedFiles.length);
      }

      const readFiles = await Promise.all(newFiles.map(file => readFileAsDataURL(file)));
      readFiles.forEach((fileData, index) => {
        selectedFiles.push({file: newFiles[index], dataURL: fileData});
      });

      updatePreview();
    });

    function updatePreview() {
      previewList.innerHTML = "";

      selectedFiles.forEach((fileObj, index) => {
        const previewItem = document.createElement("div");
        previewItem.classList.add("preview-item");
        previewItem.innerHTML = `
                    <img src="${fileObj.dataURL}" alt="이미지">
                    <button type="button" onclick="removePreview(${index})">X</button>
                `;
        previewList.appendChild(previewItem);
      });

      updateFileInput();
    }

    function updateFileInput() {
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(fileObj => dataTransfer.items.add(fileObj.file));
      photoFilesInput.files = dataTransfer.files;
    }

    window.removePreview = function (index) {
      selectedFiles.splice(index, 1);
      updatePreview();
    };

    async function readFileAsDataURL(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }

    window.cancelRegistration = function () {
      if (confirm("작성을 취소하시겠습니까?")) {
        window.location.href = "/notifications";
      }
    };
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>회원 가입</title>
    <link rel="icon" href="/images/tmp/favicon.ico" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- CSS 파일 참조 -->
    <link rel="stylesheet" th:href="@{/css/tmp/fragments/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/tmp/fragments/header.css}">
    <link rel="stylesheet" th:href="@{/css/tmp/fragments/footer.css}">
    <link rel="stylesheet" th:href="@{/css/tmp/fragments/scrollbar.css}">

    <style>
        html, body {
            height: 100%; /* 페이지 전체를 스크롤 가능하게 설정 */
            margin: 0;
            overflow-y: auto; /* 세로 스크롤 허용 */
            background-color: #f8f9fa;
        }

        .registration-container {
            max-width: 600px;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;

            /*margin: top right bottom left;*/
            margin: 100px auto 120px auto; /* 위아래 여백 추가 */
            overflow-y: auto; /* 내부 스크롤 허용 (필요한 경우) */
            z-index: 1; /* 푸터 뒤에 렌더링 */
        }

        .registration-container h1 {
            text-align: center;
            color: #003366;
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: bold;
        }

        .btn-primary {
            width: 100%;
        }

        #submitBtn {
            background-color: #003366; /* 배경색 설정 */
            border-color: #003366; /* 테두리 색 설정 */
            color: white; /* 텍스트 색상 설정 */
        }

        #checkEmailBtn, #checkPoliceUnitBtn {
            background-color: #003366; /* 배경색 설정 */
            border-color: #003366; /* 테두리 색 설정 */
            color: white; /* 텍스트 색상 설정 */
        }

    </style>

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js" defer></script>
    <script th:inline="javascript" th:if="${errorMessage != null}">
        /*<![CDATA[*/
        var msg = /*[[${errorMessage}]]*/ "";
        alert(msg);
        /*]]>*/
    </script>
</head>
<body>

<!-- 사이드바 -->
<div th:replace="~{fragments/sidebar :: sidebar}" id="sidebar"></div>

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}" class="header"></div>

<!-- 메인 콘텐츠 -->
<div class="team24-container">
    <div class="registration-container">

        <h1>회원 가입</h1>
        <form action="/member/register" method="post" id="registrationForm">
            <!-- CSRF 토큰 (Hidden) -->
            <input type="hidden" id="_csrf" name="_csrf" th:value="${_csrf.token}">

            <!-- 이메일 -->
            <div class="mb-3">
                <label for="email" class="form-label">이메일</label>
                <div class="input-group">
                    <input type="email" class="form-control" id="email" name="email" placeholder="이메일 입력" required>
                    <button class="btn btn-outline-secondary" type="button" id="checkEmailBtn">중복 확인</button>
                </div>
            </div>

            <!-- 비밀번호 -->
            <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password" class="form-control" id="password" name="password" placeholder="8-20자 비밀번호 입력"
                       required minlength="8" maxlength="20">
            </div>

            <!-- 사용자 이름 -->
            <div class="mb-3">
                <label for="memberName" class="form-label">사용자 이름</label>
                <input type="text" class="form-control" id="memberName" name="memberName" placeholder="이름 입력" required
                       minlength="2" maxlength="50">
            </div>

            <!-- 개인 전화번호 -->
            <div class="mb-3">
                <label for="personPhone" class="form-label">개인전화번호</label>
                <input type="tel" class="form-control" id="personPhone" name="personPhone" placeholder="전화번호 입력"
                       required>
            </div>

            <!-- 사무실 전화번호 -->
            <div class="mb-3">
                <label for="officePhone" class="form-label">사무실전화번호</label>
                <input type="tel" class="form-control" id="officePhone" name="officePhone" placeholder="사무실 번호 입력 (선택)">
            </div>

            <!-- 선택 항목 -->
            <div class="mb-3">
                <label for="deptName" class="form-label">광역청</label>
                <select class="form-select" id="deptName" name="deptName">
                    <option value="">선택하세요</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="stationName" class="form-label">경찰서</label>
                <select class="form-select" id="stationName" name="stationName" disabled>
                    <option value="">선택하세요</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="policeUnit" class="form-label">지구대/파출소</label>
                <div class="input-group">
                    <select class="form-select" id="policeUnit" name="policeUnitId" disabled>
                        <option value="">선택하세요</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" id="checkPoliceUnitBtn">사용 여부 확인</button>
                </div>
            </div>

            <!-- 숨겨진 필드 -->
            <input type="hidden" id="hiddenEmail" name="email">
            <input type="hidden" id="hiddenPoliceUnitId" name="policeUnitId">

            <!-- 제출 버튼 -->
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>회원 가입</button>
        </form>
    </div>
</div>

<!-- 푸터 아래 추가 여백 -->
<!--<div class="team24-footer-padding"></div>-->

<!-- 푸터 -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- JavaScript -->
<script src="/js/tmp/fragments/sidebar.js"></script>
<script src="/js/tmp/fragments/scrollbar.js"></script>
<script>
    const checkEmailBtn = document.getElementById('checkEmailBtn');
    const checkPoliceUnitBtn = document.getElementById('checkPoliceUnitBtn');
    const emailInput = document.getElementById('email');
    const hiddenEmailInput = document.getElementById('hiddenEmail');
    const deptNameSelect = document.getElementById('deptName');
    const stationNameSelect = document.getElementById('stationName');
    const policeUnitSelect = document.getElementById('policeUnit');
    const hiddenPoliceUnitInput = document.getElementById('hiddenPoliceUnitId');
    const personPhoneInput = document.getElementById('personPhone');
    const officePhoneInput = document.getElementById('officePhone');
    const memberNameInput = document.getElementById('memberName');
    const passwordInput = document.getElementById('password');


    // 중복 확인 후 임시 변수에 저장
    let emailValue = '';
    let policeUnitValue = '';

    let isEmailValid = false; // 이메일 중복 확인 결과
    let isPoliceUnitValid = false; // 파출소 중복 확인 결과

    // 버튼 활성화 조건 확인 함수
    function checkFormValidity() {
        const submitBtn = document.getElementById('submitBtn');
        if (isEmailValid && isPoliceUnitValid) {
            submitBtn.disabled = false; // 버튼 활성화
        } else {
            submitBtn.disabled = true; // 버튼 비활성화
        }
    }

    // 이메일 중복 확인 버튼 클릭 시 처리
    checkEmailBtn.addEventListener('click', function () {
        const email = emailInput.value;

        if (!email) {
            alert('이메일을 입력해주세요.');
            return;
        }

        fetch(`/api/check-email/${encodeURIComponent(email)}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    alert('이미 사용 중인 이메일입니다. 다른 이메일을 사용해주세요.');
                    isEmailValid = false;
                } else {
                    alert('사용 가능한 이메일입니다.');
                    isEmailValid = true;

                    // 이메일을 임시 변수에 저장
                    emailValue = email;
                    emailInput.disabled = true; // 이메일 필드 비활성화 (수정 불가)
                    checkEmailBtn.disabled = true; // 중복 확인 버튼 비활성화 (다시 클릭 불가)

                    // hidden 필드에 이메일 값 저장
                    hiddenEmailInput.value = emailValue;
                }
                checkFormValidity(); // 버튼 활성화 상태 확인
            })
            .catch(error => {
                console.error('에러 발생:', error);
                alert('이메일 중복 확인에 실패했습니다. 다시 시도해주세요.');
            });
    });

    // 지구대/파출소 사용 여부 확인
    checkPoliceUnitBtn.addEventListener('click', function () {
        const selectedPoliceUnitId = policeUnitSelect.value;

        if (!selectedPoliceUnitId) {
            alert('지구대/파출소를 선택해주세요.');
            return;
        }

        fetch(`/api/check-police-unit/${encodeURIComponent(selectedPoliceUnitId)}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    alert('이미 사용 중인 지구대/파출소입니다.');
                    isPoliceUnitValid = false;
                } else {
                    alert('사용 가능한 지구대/파출소입니다.');
                    policeUnitValue = selectedPoliceUnitId;

                    deptNameSelect.disabled = true; //비활성화
                    stationNameSelect.disabled = true; // 비활성화
                    policeUnitSelect.disabled = true; // 비활성화

                    hiddenPoliceUnitInput.value = policeUnitValue; // Hidden Input에 값 저장

                    checkPoliceUnitBtn.disabled = true;
                    isPoliceUnitValid = true
                }
                checkFormValidity(); // 버튼 활성화 상태 확인
            })
            .catch(error => {
                console.error('에러 발생:', error);
                alert('지구대/파출소 사용 여부 확인에 실패했습니다.');
            });
    });

    // 폼 제출 시 이메일, 사용자 이름, 전화번호, 비밀번호 검증
    document.getElementById('registrationForm').addEventListener('submit', function (event) {
        if (!emailValue) {
            alert('이메일 중복 확인을 먼저 해주세요.');
            event.preventDefault(); // 이메일 중복 확인을 하지 않으면 제출을 막습니다.
            return;
        }

        // 비밀번호 검증 (8자 이상 20자 이하)
        const password = passwordInput.value;
        if (password.length < 8 || password.length > 20) {
            alert('비밀번호는 8자 이상 20자 이하로 입력해주세요.');
            event.preventDefault();
        }

        // 사용자 이름 검증 (2자 이상 50자 이하)
        const memberName = memberNameInput.value;
        if (memberName.length < 2 || memberName.length > 50) {
            alert('사용자 이름은 2자 이상 50자 이하로 입력해주세요.');
            event.preventDefault();
            return;
        }

        // 개인 전화번호 검증 (010-123-4567, 011-1234-5678 형식)
        const personPhone = personPhoneInput.value;
        const phoneRegex = /^01[0-9]-\d{3,4}-\d{4}$/;
        if (!phoneRegex.test(personPhone)) {
            alert('개인전화번호는 010-1234-5678형식이어야 합니다.');
            event.preventDefault();
            return;
        }

        // 사무실 전화번호 검증 (062-123-4567, 02-124-5678 형식, 선택사항이므로 빈 값 허용)
        const officePhone = officePhoneInput.value;
        const officePhoneRegex = /^(02|0[3-9]{1}[0-9]{1})-\d{3,4}-\d{4}$/;
        if (officePhone && !officePhoneRegex.test(officePhone)) {
            alert('사무실전화번호는 02-123-4567 또는 062-123-4567 형식이어야 합니다.');
            event.preventDefault();
        }
    });

    document.addEventListener("DOMContentLoaded", function () {

        // 광역청 목록 가져오기
        fetch("/api/police-units/departments")
            .then(response => response.json())
            .then(departments => {
                departments.forEach(dept => {
                    const option = document.createElement("option");
                    option.value = dept;
                    option.textContent = dept;
                    deptNameSelect.appendChild(option);
                });
            });

        // 광역청 선택 시 경찰서 목록 업데이트
        deptNameSelect.addEventListener("change", function () {
            const selectedDept = deptNameSelect.value;

            stationNameSelect.innerHTML = '<option value="">선택하세요</option>';
            policeUnitSelect.innerHTML = '<option value="">선택하세요</option>';
            stationNameSelect.disabled = true;
            policeUnitSelect.disabled = true;

            if (!selectedDept) return;

            fetch(`/api/police-units/stations?deptName=${encodeURIComponent(selectedDept)}`)
                .then(response => response.json())
                .then(stations => {
                    stations.forEach(station => {
                        const option = document.createElement("option");
                        option.value = station;
                        option.textContent = station;
                        stationNameSelect.appendChild(option);
                    });
                    stationNameSelect.disabled = false;
                });
        });

        // 경찰서 선택 시 지구대/파출소 목록 업데이트
        stationNameSelect.addEventListener("change", function () {
            const selectedDept = deptNameSelect.value;
            const selectedStation = stationNameSelect.value;

            policeUnitSelect.innerHTML = '<option value="">선택하세요</option>';
            policeUnitSelect.disabled = true;

            if (!selectedStation) return;

            fetch(`/api/police-units/units?deptName=${encodeURIComponent(selectedDept)}&stationName=${encodeURIComponent(selectedStation)}`)
                .then(response => response.json())
                .then(units => {
                    units.forEach(unit => {
                        const option = document.createElement("option");
                        option.value = unit.policeUnitId;
                        option.textContent = `${unit.policeUnitName}${unit.policeUnitTypeDescription}`; // 한글 설명 사용
                        policeUnitSelect.appendChild(option);
                    });
                    policeUnitSelect.disabled = false;
                });
        });
    });

</script>
</body>
</html>
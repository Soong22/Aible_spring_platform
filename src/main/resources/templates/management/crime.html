<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, minimum-scale=1.0, user-scalable=yes" />
    <meta name="keywords" content="KT Avile School 6ê¸° 24ì¡°" />
    <meta name="description" content="ë²”ì£„ì™€ ì „ìŸ : AI ë²”ì£„ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì€, ì‹œë¯¼ì˜ ì•ˆì „í•˜ê³  í–‰ë³µí•œ ìƒí™œì„ ìœ„í•˜ì—¬ 24ì‹œê°„ ë°©ë²”ê´€ì œ ë° ë²”ì£„ì ì˜ˆì¸¡ì„ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤." />

    <!-- CSS íŒŒì¼ë“¤ -->
    <link rel="stylesheet" type="text/css" href="/css/font.css" />
    <link rel="stylesheet" type="text/css" href="/css/cctv/main.css" />
    <link rel="stylesheet" type="text/css" href="/css/management.css" />

    <!-- JS íŒŒì¼ë“¤ -->
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/jquery.screen.min.js"></script>
    <script src="/js/jquery.menu.min.js"></script>
    <script src="/js/jquery.customForm.min.js"></script>
    <script src="/js/slick.min.js"></script>
    <script src="/js/slick.extensions.min.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/program.min.js"></script>
    <script src="/js/cctv/common.js"></script>
    <script src="/js/cctv/main.js"></script>
    <script src="/js/loading.js"></script>
    <script src="/js/myLogin.js"></script>

    <title>ë²”ì£„ ì´ë ¥ ê´€ë¦¬</title>

    <!-- ë©”ì¸ íƒ€ì´í‹€ -->
    <style>
        .hero {
            padding: 60px 20px;
            background: #fff;
            text-align: center;
        }

        .sub-title {
            font-size: 14px;
            color: #666;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .main-title {
            font-size: 36px;
            font-weight: bold;
            color: #222;
            margin-bottom: 30px;
        }

        .spacer {
            height: 300px; /* ì—¬ë°± í¬ê¸° */
            background: transparent; /* ë°°ê²½ ì—†ìŒ */
        }

        /* ë°°ê²½ìƒ‰ */
        #wrapper {
            background-color: #f8f9fa;
        }

        .table-section {
            /* ğŸ”¥ í‘¸í„°ë¥¼ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ ìµœëŒ€ ë†’ì´ ì„¤ì • */
            max-height: 300px; /* í•„ìš”ì— ë”°ë¼ ì¡°ì ˆ */
            overflow-y: auto; /* ë‚´ìš©ì´ ë§ì•„ì§€ë©´ ìŠ¤í¬ë¡¤ ìƒì„± */
        }
    </style>
</head>


<!-- í—¤ë” (Thymeleaf ì‚¬ìš©) -->
<div th:replace="~{fragments/header :: header}" class="header"></div>


<!-- ë©”ì¸ íƒ€ì´í‹€ -->
<header class="hero">
    <h3 class="sub-title"> ë²”ì£„ ì´ë ¥ ê´€ë¦¬ </h3>
    <h1 class="main-title">ë²”ì£„ì™€ì˜ ì „ìŸ</h1>
</header>


<!-- ë©”ì¸ ì½˜í…ì¸  -->
<body>
<div class="grid-container">
    <!-- ì¢Œì¸¡: ìŠ¤íŠ¸ë¦¬ë° ì˜ìƒ í˜¹ì€ ê¸°íƒ€ ì½˜í…ì¸  -->
    <div class="video-section">
        <img src="https://crime-detect.run.goorm.io/predict" alt="MJPEG Stream" />
    </div>

    <!-- ìš°ì¸¡: ìµœì‹  ë²”ì£„ ì•Œë¦¼ ì´ë¯¸ì§€ -->
    <div class="image-section">
        <!-- ì „ì²´í™”ë©´ í† ê¸€ ë²„íŠ¼ -->
        <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">â›¶</button>

        <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
        <button id="downloadBtn" onclick="downloadImage()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5V13a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V10.4a.5.5 0 0 1 1 0V13a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V10.4a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
        </button>

        <img id="crime-image" src="/images/placeholder.jpg" alt="ë²”ì£„ ì•Œë¦¼ ì´ë¯¸ì§€" />
    </div>

    <!-- í•˜ë‹¨: ë²”ì£„ ì•Œë¦¼ ì •ë³´ í…Œì´ë¸” -->
    <div class="table-section">
        <table id="crime-table">
            <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>ë²”ì£„ ìœ í˜•</th>
                <th>ë²”ì£„ íšŸìˆ˜</th>
                <th>ì¶œì†Œ ì—¬ë¶€</th>
                <th>ìœ„í—˜ë„</th>
                <th>ì •í™•ë„</th>
                <th>ì¼ì‹œ</th>
            </tr>
            </thead>
            <tbody>
            <!-- JavaScriptë¡œ ë°ì´í„° ì¶”ê°€ -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§·íŒ… í•¨ìˆ˜: "yyyyMMdd_HHmmss" â†’ "yyyyë…„ MMì›” ddì¼ HH:mm:ss"
    function formatTimestamp(ts) {
        if (ts) {
            var parts = ts.split("_");
            if (parts.length === 2 && parts[0].length === 8 && parts[1].length === 6) {
                var year = parts[0].substring(0, 4);
                var month = parts[0].substring(4, 6);
                var day = parts[0].substring(6, 8);
                var hour = parts[1].substring(0, 2);
                var minute = parts[1].substring(2, 4);
                var second = parts[1].substring(4, 6);
                return year + "ë…„ " + month + "ì›” " + day + "ì¼ " + hour + ":" + minute + ":" + second;
            }
        }
        return ts;
    }

    // ì „ì²´í™”ë©´ í† ê¸€ í•¨ìˆ˜ (ë¬¸ì„œ ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨)
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.body.requestFullscreen().then(() => {
                console.log("ì „ì²´í™”ë©´ ëª¨ë“œ ì§„ì…");
            }).catch(err => {
                console.error(`ì „ì²´í™”ë©´ ìš”ì²­ ì—ëŸ¬: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen().then(() => {
                console.log("ì „ì²´í™”ë©´ ëª¨ë“œ ì¢…ë£Œ");
            }).catch(err => {
                console.error(`ì „ì²´í™”ë©´ ì¢…ë£Œ ì—ëŸ¬: ${err.message} (${err.name})`);
            });
        }
    }

    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    function downloadImage() {
        const image = document.getElementById("crime-image");
        const imageUrl = image.src;
        const link = document.createElement("a");
        link.href = imageUrl;
        let fileName = imageUrl.substring(imageUrl.lastIndexOf('/') + 1);
        if(fileName.indexOf('?') !== -1){
            fileName = fileName.substring(0, fileName.indexOf('?'));
        }
        link.download = fileName || "downloaded_image.jpg";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ë²”ì£„ ì•Œë¦¼ ë°ì´í„°ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
    function updateCrimeData() {
        $.ajax({
            url: '/api/crime',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                var tableBody = $('#crime-table tbody');
                tableBody.empty();
                data.slice().reverse().forEach(function(alert) {
                    var formattedTimestamp = formatTimestamp(alert.timestamp);
                    var row = `<tr>
                                        <td>${alert.name ? alert.name : '-'}</td>
                                        <td>${alert.crimeType ? alert.crimeType : '-'}</td>
                                        <td>${alert.crimeCount}</td>
                                        <td>${alert.released ? 'ì¶œì†Œ' : 'ë¯¸ì¶œì†Œ'}</td>
                                        <td>${alert.riskLevel ? alert.riskLevel : '-'}</td>
                                        <td>${parseFloat(alert.accuracy).toFixed(1)}%</td>
                                        <td>${formattedTimestamp}</td>
                                   </tr>`;
                    tableBody.append(row);
                });
                if (data.length > 0) {
                    var latest = data[data.length - 1];
                    $('#crime-image').attr('src', latest.imageUrl + '?t=' + new Date().getTime());
                }
            },
            error: function(err) {
                console.error('ë²”ì£„ ì•Œë¦¼ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:', err);
            }
        });
    }

    $(document).ready(function(){
        updateCrimeData();
        setInterval(updateCrimeData, 5000);
    });
</script>

<!-- ê³µê°„ ì¶”ê°€ -->
<div class="spacer"></div>

<!-- í‘¸í„° (Thymeleaf ì‚¬ìš©) -->
<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>

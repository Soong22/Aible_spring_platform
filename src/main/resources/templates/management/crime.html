<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=2.0, minimum-scale=1.0, user-scalable=yes" />
    <meta name="keywords" content="KT Avile School 6기 24조" />
    <meta name="description" content="범죄와 전쟁 : AI 범죄모니터링 시스템은, 시민의 안전하고 행복한 생활을 위하여 24시간 방범관제 및 범죄자 예측을 제공하고 있습니다." />

    <!-- CSS 파일들 -->
    <link rel="stylesheet" type="text/css" href="/css/font.css" />
    <link rel="stylesheet" type="text/css" href="/css/cctv/main.css" />
    <link rel="stylesheet" type="text/css" href="/css/management.css" />

    <!-- JS 파일들 -->
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/jquery.screen.min.js"></script>
    <script src="/js/jquery.menu.min.js"></script>
    <script src="/js/jquery.customForm.min.js"></script>
    <script src="/js/slick.min.js"></script>
    <script src="/js/slick.extensions.min.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/program.min.js"></script>
    <script src="/js/cctv/common.js"></script>
    <script src="/js/cctv/main.js"></script>
    <script src="/js/loading.js"></script>

    <title>범죄 알림 관리</title>
</head>

<body>

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}" class="header"></div>

<!-- 알림 -->
<div th:replace="~{fragments/notification :: notification}"></div>

<!-- 전체화면 토글 버튼 -->
<button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">⛶</button>

<div class="grid-container">
    <!-- 좌측: 스트리밍 영상 혹은 기타 콘텐츠 (원래 코드에서 사용하던 부분, 필요에 따라 수정) -->
    <div class="video-section">
        <img src="https://crime-detect.run.goorm.io/predict" alt="MJPEG Stream" />
    </div>

    <!-- 우측: 최신 범죄 알림 이미지 -->
    <div class="image-section">
        <img id="crime-image" src="/images/placeholder.jpg" alt="범죄 알림 이미지" />
    </div>

    <!-- 하단: 범죄 알림 정보 테이블 -->
    <div class="table-section">
        <table id="crime-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>분류</th>
                <th>일시</th>
                <th>정확도</th>
                <th>이름</th>
                <th>범죄 유형</th>
                <th>범죄 횟수</th>
                <th>출소 여부</th>
                <th>위험도</th>
            </tr>
            </thead>
            <tbody>
            <!-- JavaScript로 데이터 추가 -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // 전체화면 토글 함수
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.body.requestFullscreen().then(() => {
                console.log("전체화면 모드 진입");
            }).catch(err => {
                console.error(`전체화면 요청 에러: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen().then(() => {
                console.log("전체화면 모드 종료");
            }).catch(err => {
                console.error(`전체화면 종료 에러: ${err.message} (${err.name})`);
            });
        }
    }

    // 범죄 알림 데이터를 주기적으로 갱신하는 함수
    function updateCrimeData() {
        $.ajax({
            url: '/api/crime',  // CrimeController의 GET 매핑 주소
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                var tableBody = $('#crime-table tbody');
                tableBody.empty();

                // 최신 데이터부터 표시 (역순 정렬)
                data.slice().reverse().forEach(function(alert) {
                    var row = `<tr>
                                    <td>${alert.id}</td>
                                    <td>${alert.type}</td>
                                    <td>${alert.timestamp}</td>
                                    <td>${parseFloat(alert.accuracy).toFixed(1)}%</td>
                                    <td>${alert.name ? alert.name : '-'}</td>
                                    <td>${alert.crimeType ? alert.crimeType : '-'}</td>
                                    <td>${alert.crimeCount}</td>
                                    <td>${alert.released ? '출소' : '미출소'}</td>
                                    <td>${alert.riskLevel ? alert.riskLevel : '-'}</td>
                               </tr>`;
                    tableBody.append(row);
                });

                // 최신 알림 이미지 업데이트 (이미지가 존재할 경우)
                if (data.length > 0) {
                    var latest = data[data.length - 1];
                    $('#crime-image').attr('src', latest.imageUrl + '?t=' + new Date().getTime());
                }
            },
            error: function(err) {
                console.error('범죄 알림 데이터 조회 오류:', err);
            }
        });
    }

    // 페이지 로드 시 및 5초마다 갱신
    $(document).ready(function(){
        updateCrimeData();
        setInterval(updateCrimeData, 5000);
    });
</script>

<!-- 푸터 (Thymeleaf 사용) -->
<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>

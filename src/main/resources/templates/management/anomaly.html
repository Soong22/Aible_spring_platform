<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport"
          content="width=device-width, height=device-height, initial-scale=1.0,
                   maximum-scale=2.0, minimum-scale=1.0, user-scalable=yes" />
    <meta name="keywords" content="KT Avile School 6기 24조" />
    <meta name="description" content="범죄와 전쟁 : AI 범죄모니터링 시스템은, 시민의 안전하고 행복한 생활을 위하여 24시간 방범관제 및 범죄자 예측을 제공하고 있습니다." />

    <!-- css  -->
    <link rel="stylesheet" type="text/css" href="/css/font.css" />
    <link rel="stylesheet" type="text/css" href="/css/cctv/main.css" />
    <link rel="stylesheet" type="text/css" href="/css/management.css" />

    <!-- js  -->
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/jquery.screen.min.js"></script>
    <script src="/js/jquery.menu.min.js"></script>
    <script src="/js/jquery.customForm.min.js"></script>
    <script src="/js/slick.min.js"></script>
    <script src="/js/slick.extensions.min.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/program.min.js"></script>
    <script src="/js/cctv/common.js"></script>
    <script src="/js/cctv/main.js"></script>
    <script src="/js/loading.js"></script>

    <title>이상 행동 탐지</title>
</head>

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}" class="header"></div>


<!-- 메인 콘텐츠 -->
<body class="fullscreen-container" id="fullscreen-container">
<div class="grid-container">

    <!-- 좌측: MJPEG 스트리밍 (FastAPI의 /predict URL) -->
    <div class="video-section">
        <img src="https://crime-detect.run.goorm.io/predict" alt="MJPEG Stream" />
    </div>

    <!-- 우측: 알람 이미지 영역 (최신 알람 이미지로 업데이트) -->
    <div class="image-section">
        <!-- 전체화면 토글 버튼 -->
        <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">⛶</button>

        <!-- 다운로드 버튼 추가 -->
        <button id="downloadBtn" onclick="downloadImage()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5V13a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V10.4a.5.5 0 0 1 1 0V13a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V10.4a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
        </button>

        <img id="alarm-image" src="" alt="이상 행동 탐지 이미지" />

    </div>

    <!-- 하단: 알람 정보 테이블 -->
    <div class="table-section">
        <table id="alarm-table">
            <thead>
            <tr>
                <th>Class_Name</th>
                <th>Accuracy</th>
                <th>Timestamp</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</div>

<script>

    // 타임스탬프 포맷팅 함수: "yyyyMMdd_HHmmss" → "yyyy년 MM월 dd일 HH:mm:ss"
    // 타임스탬프 포맷팅 함수
    function formatTimestamp(ts) {
        if (ts) {
            var parts = ts.split("_");
            if (parts.length === 2 && parts[0].length === 8 && parts[1].length === 6) {
                var year = parts[0].substring(0, 4);
                var month = parts[0].substring(4, 6);
                var day = parts[0].substring(6, 8);
                var hour = parts[1].substring(0, 2);
                var minute = parts[1].substring(2, 4);
                var second = parts[1].substring(4, 6);
                return year + "년 " + month + "월 " + day + "일 " + hour + ":" + minute + ":" + second;
            }
        }
        return "0000년 00월 00일 00:00:00";
    }

    // 전체화면 토글 함수: 헤더와 푸터는 제외하고, fullscreen-container만 전체화면 전환
function toggleFullscreen() {
    const elem = document.getElementById("fullscreen-container");
    if (!document.fullscreenElement) {
        elem.requestFullscreen().then(() => {
            console.log("전체화면 모드 진입");
        }).catch(err => {
            console.error(`전체화면 요청 에러: ${err.message} (${err.name})`);
        });
    } else {
        document.exitFullscreen().then(() => {
            console.log("전체화면 모드 종료");
        }).catch(err => {
            console.error(`전체화면 종료 에러: ${err.message} (${err.name})`);
        });
    }
}

// 알람 데이터를 주기적으로 갱신하는 함수
    function updateAnomalyData() {
        $.ajax({
            url: '/api/anomalies',
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                let tableBody = $('#alarm-table tbody');
                tableBody.empty();

                // 최신 데이터부터 역순 정렬하여 추가
                data.slice().reverse().forEach(function(anomaly) {
                    let row = `<tr>
                    <td>${anomaly.type}</td>
                    <td>${anomaly.accuracy.toFixed(1)}%</td>
                    <td>${formatTimestamp(anomaly.timestamp)}</td>
                </tr>`;
                    tableBody.append(row);
                });

                // 최신 알람 이미지 업데이트 (캐시 무효화를 위해 타임스탬프 추가)
                if(data.length > 0) {
                    let latest = data[data.length - 1];
                    $('#alarm-image').attr('src', latest.imageUrl + '?t=' + new Date().getTime());
                }
            },
            error: function(err) {
                console.error('알람 데이터 조회 에러:', err);
            }
        });
    }

// 다운로드 버튼 클릭 시 호출되는 함수
function downloadImage() {
    const image = document.getElementById("alarm-image");
    const imageUrl = image.src;
    // 임시 <a> 엘리먼트를 생성하여 다운로드 속성을 추가한 후 클릭
    const link = document.createElement("a");
    link.href = imageUrl;
    // URL에서 파일 이름 추출 (쿼리스트링은 제거)
    let fileName = imageUrl.substring(imageUrl.lastIndexOf('/') + 1);
    if(fileName.indexOf('?') !== -1){
        fileName = fileName.substring(0, fileName.indexOf('?'));
    }
    // 다운로드될 파일명 지정 (없으면 기본값 사용)
    link.download = fileName || "downloaded_image.jpg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// 페이지 로드시와 5초마다 업데이트
$(document).ready(function(){
updateAnomalyData();
setInterval(updateAnomalyData, 5000);
});
</script>
</body>

<!-- 푸터 (Thymeleaf 사용) -->
<div th:replace="~{fragments/footer :: footer}"></div>
</html>

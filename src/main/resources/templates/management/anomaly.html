<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport"
          content="width=device-width, height=device-height, initial-scale=1.0,
                   maximum-scale=2.0, minimum-scale=1.0, user-scalable=yes" />
    <meta name="keywords" content="KT Avile School 6기 24조" />
    <meta name="description" content="범죄와 전쟁 : AI 범죄모니터링 시스템은, 시민의 안전하고 행복한 생활을 위하여 24시간 방범관제 및 범죄자 예측을 제공하고 있습니다." />

    <!-- css  -->
    <link rel="stylesheet" type="text/css" href="/css/font.css" />
    <link rel="stylesheet" type="text/css" href="/css/cctv/main.css" />
    <link rel="stylesheet" type="text/css" href="/css/management.css" />

    <!-- js  -->
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/jquery.screen.min.js"></script>
    <script src="/js/jquery.menu.min.js"></script>
    <script src="/js/jquery.customForm.min.js"></script>
    <script src="/js/slick.min.js"></script>
    <script src="/js/slick.extensions.min.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/program.min.js"></script>
    <script src="/js/cctv/common.js"></script>
    <script src="/js/cctv/main.js"></script>
    <script src="/js/loading.js"></script>

    <title>이상 행동 탐지</title>
</head>

<!-- 헤더 -->
<div th:replace="~{fragments/header :: header}" class="header"></div>


<!-- 메인 콘텐츠 -->
<body class="fullscreen-container" id="fullscreen-container">
<div class="grid-container">

    <!-- 좌측: MJPEG 스트리밍 (FastAPI의 /predict URL) -->
    <div class="video-section">
        <img src="https://crime-detect.run.goorm.io/predict" alt="MJPEG Stream" />
    </div>

    <!-- 우측: 알람 이미지 영역 (최신 알람 이미지로 업데이트) -->
    <div class="image-section">
        <!-- 전체화면 토글 버튼 -->
        <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">⛶</button>
        <img id="alarm-image" src="/images/AI.jpeg" alt="Alarm" />
    </div>

    <!-- 하단: 알람 정보 테이블 -->
    <div class="table-section">
        <table id="alarm-table">
            <thead>
            <tr>
                <th>Class_Name</th>
                <th>Accuracy</th>
                <th>Timestamp</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</div>

<script>
    // 전체화면 토글 함수: 헤더와 푸터는 제외하고, fullscreen-container만 전체화면 전환
function toggleFullscreen() {
    const elem = document.getElementById("fullscreen-container");
    if (!document.fullscreenElement) {
        elem.requestFullscreen().then(() => {
            console.log("전체화면 모드 진입");
        }).catch(err => {
            console.error(`전체화면 요청 에러: ${err.message} (${err.name})`);
        });
    } else {
        document.exitFullscreen().then(() => {
            console.log("전체화면 모드 종료");
        }).catch(err => {
            console.error(`전체화면 종료 에러: ${err.message} (${err.name})`);
        });
    }
}

// 알람 데이터를 주기적으로 갱신하는 함수
function updateAnomalyData() {
$.ajax({
    url: '/api/anomalies',
    type: 'GET',
    dataType: 'json',
    success: function(data) {
        // data: AnomalyData 객체들의 배열
        let tableBody = $('#alarm-table tbody');
        tableBody.empty();

        // 최신 데이터부터 표시 (역순 정렬)
        data.slice().reverse().forEach(function(anomaly) {
            // 임의로 위치, 경찰서 등은 고정값 또는 필요에 따라 업데이트
            let row = `<tr>
                <td>${anomaly.class_name}</td>
                <td>${anomaly.accuracy.toFixed(1)}%</td>
                <td>${anomaly.timestamp}</td>
            </tr>`;
            tableBody.append(row);
        });

        // 알람 이미지 업데이트: 가장 최신 알람 이미지 사용
        if(data.length > 0) {
            let latest = data[data.length - 1];
            $('#alarm-image').attr('src', latest.imageUrl + '?t=' + new Date().getTime());
            // 캐시 무효화를 위해 타임스탬프 추가
        }
    },
    error: function(err) {
        console.error('알람 데이터 조회 에러:', err);
    }
});
}

// 페이지 로드시와 5초마다 업데이트
$(document).ready(function(){
updateAnomalyData();
setInterval(updateAnomalyData, 5000);
});
</script>
</body>

<!-- 푸터 (Thymeleaf 사용) -->
<div th:replace="~{fragments/footer :: footer}"></div>
</html>

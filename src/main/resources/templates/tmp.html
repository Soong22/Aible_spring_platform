<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>CSRF Example</title>
  <!-- CSRF 메타 태그 추가 -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<h1>이메일 인증</h1>

<!-- 이메일 입력 + 인증번호 전송 버튼 -->
<input type="email" id="emailInput" />
<button type="button" id="sendBtn">인증번호 전송</button>

<br/><br/>

<!-- 인증번호 입력 + 확인 버튼 -->
<input type="text" id="codeInput" />
<button type="button" id="verifyBtn">인증번호 확인</button>

<div id="message"></div>

<script>
  // 1) 메타 태그에서 CSRF 토큰 정보 가져오기
  const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

  // 2) 인증번호 전송
  document.getElementById('sendBtn').addEventListener('click', function() {
    const email = document.getElementById('emailInput').value;
    fetch('/api/email/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        // CSRF 헤더를 동적으로 추가
        [csrfHeader]: csrfToken
      },
      body: 'email=' + encodeURIComponent(email)
    })
            .then(response => response.json())
            .then(data => {
              document.getElementById('message').textContent = data.message;
            })
            .catch(err => {
              console.error(err);
              document.getElementById('message').textContent = "전송 오류";
            });
  });

  // 3) 인증번호 확인
  document.getElementById('verifyBtn').addEventListener('click', function() {
    const email = document.getElementById('emailInput').value;
    const code = document.getElementById('codeInput').value;
    fetch('/api/email/verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        [csrfHeader]: csrfToken
      },
      body: 'email=' + encodeURIComponent(email) + '&code=' + encodeURIComponent(code)
    })
            .then(response => response.json())
            .then(data => {
              document.getElementById('message').textContent = data.message;
            })
            .catch(err => {
              console.error(err);
              document.getElementById('message').textContent = "확인 오류";
            });
  });
</script>

</body>
</html>
